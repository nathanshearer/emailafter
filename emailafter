#!/usr/bin/env bash

NAME="emailafter"
CODENAME="emailafter"
COPYRIGHT="Copyright (C) 2018 Nathan Shearer"
LICENSE="GNU General Public License 2.0"
VERSION="1.0.1.0"

# \brief Displays the help and exits the program
function emailafter_help
{
	#     01234567890123456789012345678901234567890123456789012345678901234567890123456789
	echo "Description:"
	echo "  Send an email after running a command."
	echo
	echo "Usage:"
	echo "  $CODENAME [options] mail@example.com command [args]"
	echo
	echo "Options:"
	echo "  -h, --help"
	echo "    Display this help message and exit."
	echo "  -p, --pretend"
	echo "    Print out the e-mail address and the command that would be executed."
	echo
	echo "Examples:"
	echo "  $CODENAME -p mail@example.com du --apparent-size -b -l -x /mnt/storage"
	echo "  $CODENAME mail@example.com cp -afv /mnt/storage /mnt/backup"
	echo "  $CODENAME mail@example.com 7z a /mnt/offsite/storage.7z /mnt/backup/storage"
	echo
	echo "Version:"
	echo "  $NAME $VERSION"
	echo "  $COPYRIGHT"
	echo "  Licensed under $LICENSE"
	exit
}

if [ $# -eq 0 -o "$1" = "-h" -o "$1" = "--help" ]; then
	emailafter_help
fi

if [ "$1" = "-p" -o "$1" = "--pretend" ]; then
	shift
	EMAIL="$1"
	shift
	echo "E-Mail Address: $EMAIL"
	echo "$@"
	exit
fi

EMAIL="$1"
shift

"$@"
STATUS="$?"

echo "The following command has completed: \"$@\"" | mail -s "$(hostname --fqdn): command complete" "$EMAIL"
exit "$STATUS"
